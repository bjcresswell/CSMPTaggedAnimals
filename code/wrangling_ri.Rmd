---
title: "Analysing residency indices"
aauthor: "Ben Cresswell"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
 html_document:
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: textmate
    theme: spacelab
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: inline
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Load required packages
```{r packages, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(sp)
library(rgdal)
library(rgeos)
library(adehabitatHR)
library(leaflet)
library(ggmap)    # for fortifying shapefiles
library(readxl)
library(scatterpie)
library(collapse)
library(magrittr)
library(tidyverse)
```



# Residency index

The residency index is the number of days an animal was detected at each receiver (site or station residency) or reef (reef or installation residency) divided by the number of days monitored (i.e. number of days from the tagging date to the date of receiver retrieval) (Papastamatiou et al. 2010; Espinoza et al. 2011).


# Load data - probably will be already loaded but if not:
```{r load-data}
rm(list=ls())
load(file = "../data/RData/alldata.RData")
```

# Check
```{r}
glimpse(alldata)
```

Residence index will need to be calculated for each individual organism at station and installation level (i.e. per receiver and per reef)

Let's start with GRS on Osprey...

```{r}
os_grs <- alldata %>% 
  filter(Location == 'Osprey') %>% 
  filter(Common_name == 'Grey Reef')
```

# 'Date' in this df is the tagging date and we need to change it to class date (could maybe change this earlier on in wrangling process)
```{r}
os_grs <- 
  os_grs %>% 
  mutate(tag_date = as.Date(Date), .keep = 'unused')
```


Now we'll need to summarise this df so that we have one line per individual which will give us:
- Number of days detected over the study period
- Number of days at large (from tagging to receiver retrieval)

## Will start by calculating end date for deployment.
If(when) we do this at individual station level, we can use the exact recovery date for that receiver but for the whole installation we'll just go with the earliest receiver removal.

## Reload details for the 2nd VR2W deployment (i.e. the latest one)
```{r}
osprey_dep2 <- read_excel('../data/receiver_list_dep2.xlsx', trim_ws = TRUE) %>%
  tibble() %>% # Make into tibble format
  mutate_if(is.character, as.factor) %>%  # Sort out variables
  filter(installation_name == 'Osprey')
```

## And check when receivers removed
```{r}
osprey_dep2 %$% 
  summary(recoverydatetime_timestamp)
```
All receivers recovered between 3 and 4 March 2022. So will roll with 3rd march as deployment end date


## Now need to calculate # days detected and # days in deployment
```{r}
os_grs_days <- 
  os_grs %>% 
  mutate(detection_date = as.Date(detection_timestamp)) %>% 
  dplyr::select(transmitter_id, tag_date, detection_date) %>% 
  distinct() %>% 
  group_by(transmitter_id, tag_date) %>% 
  mutate(detected_days = n()) %>% 
  dplyr::select(!detection_date) %>% 
  distinct() %>% 
  mutate(deployment_end = date('2022-03-03')) %>% 
  mutate(deployment_days = as.integer(deployment_end - tag_date))
```
So 51 organisms. If you check the tag asst scripts there are 52 animals tagged but I think we had one disappear instantly.. Need to check.


# Now can calculate Ri 
```{r}
os_grs_days <- 
  os_grs_days %>% 
  mutate(Ri = detected_days/deployment_days)
```


# Plots
```{r}
os_grs_days %>% 
  ggplot() +
  geom_boxplot(y = 'Ri', x = 'tag_date')



```









#####  OLDER WORK  ######



# Site residency - days spent at each site
```{r}
site_days <- alldata %>% 
  mutate(detection_date = as.Date(detection_timestamp)) %>%                     # Turn time stamp into date
  dplyr::select(transmitter_id, detection_date, site_code, installation_name)# %>%      # Variables required
  select(!detection_date) %>% 
  #distinct() # %>% 
  group_by(transmitter_id, site_code) %>% 
  mutate(summarise(n = n()))

           
           
           
           
           
           
match(detection_date, sort(unique(detection_date))))
           
```

# Reef residency - days spent at each reef
```{r}
reef_days <- alldata %>% 
  mutate(detection_date = as.Date(detection_timestamp)) %>% 
  dplyr::select(transmitter_id, detection_date, site_code, installation_name) %>% 
  group_by(transmitter_id, installation_name) %>% 
  mutate(reef_days = match(detection_date, sort(unique(detection_date)))) %>% 
  dplyr::select(!c(detection_date, site_code)) %>% 
  distinct()

summary(reef_days$installation_name)
```

So now we have summaries of how many days these organisms were detected at both individual sites as well as reefs
Now we need to know how many days each organism was at large during the study period: the date of removal of the VR2W minus the date the animal was tagged.




```{r}

site_residence <- receivers %>% 
  select(site_code, rcvr_enddate) %>% 
  merge(site_days, by = 'site_code')
  
  
  
reef_residence <- receivers %>%   
  select(installation_name, rcvr_enddate) %>% 
  merge(reef_days, by = 'installation_name')



```







# Load receiver metadata again
```{r}
# Deployment 1
vr2ws_dep1 <- read_excel('../data/receiver_list_dep1.xlsx', trim_ws = TRUE) %>%
  tibble() %>% # Make into tibble format
  mutate_if(is.character, as.factor) # Sort out variables

# Deployment 2
vr2ws_dep2 <- read_excel('../data/receiver_list_dep2.xlsx', trim_ws = TRUE) %>%
  tibble() %>% # Make into tibble format
  mutate_if(is.character, as.factor) # Sort out variables
```

## Combine 
```{r}
receivers <- vr2ws_dep1 %>% 
  bind_rows(vr2ws_dep2) %>% 
  mutate(rcvr_enddate = ymd(recoverydatetime_timestamp)) %>%
  group_by(installation_name, site_code) %>% 
  filter(rcvr_enddate == max(rcvr_enddate))

```




```{r}


receiver_days <- alldata %>% 
    mutate(receiver_days = as.double(recoverydatetime_timestamp - deploymentdatetime_timestamp)) %>% 
  select(receiver_name, site_code, installation_name, receiver_days) %>% 
  distinct()
  
  
  
  
  group_by(installation_name, site_code) %>% 
  summarise(receiver_days = sum(receiver_days))
receiver_days
```





























